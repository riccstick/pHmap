#!/bin/bash
#
# ARG_POSITIONAL_INF([pdb],[pdb files to process)],[1])
# ARG_POSITIONAL_DOUBLEDASH([])

# ARG_OPTIONAL_SINGLE([ph_range],[r],[range of pH's in quotes!; 'start stop step' e.g. '5 7 0.5'])
# ARG_OPTIONAL_SINGLE([ligand],[l],[input mol2 file])
# ARG_OPTIONAL_SINGLE([set_view],[s],[imports view settings from file; input file must contain\nthe PyMol output of the get_view command!])

# ARG_OPTIONAL_SINGLE([level],[],[level of pos and neg charge representation\n],[5])
# ARG_OPTIONAL_SINGLE([rampcolors],[],[colors for ramp; 3 colors comma seperated\n],[red, white, blue])
# ARG_OPTIONAL_BOOLEAN([surface_above],[],[surface_ramp_above_mode from PyMol\n],[on])

# ARG_OPTIONAL_BOOLEAN([axis_update],[],[updates only the pH numbers of the x-axis\n])
# ARG_OPTIONAL_SINGLE([digits],[],[digits of pH values in axis; if pH values like 5.25 change to 2!\n],[1])
# ARG_OPTIONAL_SINGLE([font],[],[font of the axis; type <convert -list font>\nto get a full list of fonts available\n],[Helvetica])
# ARG_OPTIONAL_SINGLE([fontsize],[],[font size],[40])
# ARG_OPTIONAL_SINGLE([weight],[],[font weight; type  <convert -list weight>\n to get a list of available weight settings\n],[Normal])
# ARG_OPTIONAL_SINGLE([stretch],[],[font stretch; type  <convert -list stretch>\n to get a list of available stretch settings\n],[Normal])
# ARG_OPTIONAL_SINGLE([style],[],[font style; type  <convert -list style>\n to get a list of available style settings\n],[Normal])

# ARG_OPTIONAL_BOOLEAN([ramp],[],[enable/disable ramp\n],[on])
# ARG_OPTIONAL_SINGLE([xalign],[],[x-axis alignment of the pH value text; type  <convert -list gravity>\n to get a list of available alignment settings\n],[Center])
# ARG_OPTIONAL_SINGLE([yalign],[],[y-axis alignment of the label text; type  <convert -list gravity>\n to get a list of available alignment settings\n],[Center])
# ARG_OPTIONAL_SINGLE([size],[],[individual picture size: default means 500x500 pixel (quadratic; 300 dpi)\n],[500])
# ARG_OPTIONAL_SINGLE([background],[],[background color: None, colors e.g. white, black])

# ARG_HELP([+-------+\n| pHmap |\n+-------+\nby Erik Breslmayr, 2020\n \npHmap uses pdb2pqr, apbs to calcualte electrostatic surface potentials,\nwhich are visualized by generating 2D pictures with PyMol. Several pH's\nand pdb files can be processed and will be combined into one figure. On\nthe x-axis the pH's and on the y-axis the filenames will be added.\n \nExamples:\npHmap protein.pdb mutant.pdb -r '4 7 0.5' -l ligand.mol2 -s set_view.txt\npHmap protein.pdb mutant.pdb -r '4 7 0.5' -l ligand.mol2 -s set_view.txt --axis_update --font Helvetica --fontsize 60\npHmap protein.pdb mutant.pdb -r '4 7 0.25' -l ligand.mol2 -s set_view.txt --digits 2\n])
# ARG_VERSION([echo $0 v2.0])
# ARG_OPTIONAL_REPEATED([include],[I],[Directory for temporary folder],['/tmp'])
# ARGBASH_GO()
# needed because of Argbash --> m4_ignore([
### START OF CODE GENERATED BY Argbash v2.8.1 one line above ###
# Argbash is a bash code generator used to get arguments parsing right.
# Argbash is FREE SOFTWARE, see https://argbash.io for more info


die()
{
	local _ret="${2:-1}"
	test "${_PRINT_HELP:-no}" = yes && print_help >&2
	echo "$1" >&2
	exit "${_ret}"
}


begins_with_short_option()
{
	local first_option all_short_options='rlshvI'
	first_option="${1:0:1}"
	test "$all_short_options" = "${all_short_options/$first_option/}" && return 1 || return 0
}

# THE DEFAULTS INITIALIZATION - POSITIONALS
_positionals=()
_arg_pdb=('' )
# THE DEFAULTS INITIALIZATION - OPTIONALS
_arg_ph_range=
_arg_ligand=
_arg_set_view=
_arg_level="5"
_arg_rampcolors="red, white, blue"
_arg_surface_above="on"
_arg_axis_update="off"
_arg_digits="1"
_arg_font="Helvetica"
_arg_fontsize="40"
_arg_weight="Normal"
_arg_stretch="Normal"
_arg_style="Normal"
_arg_ramp="on"
_arg_xalign="Center"
_arg_yalign="Center"
_arg_size="500"
_arg_background=
_arg_include=('/tmp')


print_help()
{
	printf '%s\n' "+-------+
| pHmap |
+-------+
by Erik Breslmayr, 2020

pHmap uses pdb2pqr, apbs to calcualte electrostatic surface potentials,
which are visualized by generating 2D pictures with PyMol. Several pH's
and pdb files can be processed and will be combined into one figure. On
the x-axis the pH's and on the y-axis the filenames will be added.

Examples:
pHmap protein.pdb mutant.pdb -r '4 7 0.5' -l ligand.mol2 -s set_view.txt
pHmap protein.pdb mutant.pdb -r '4 7 0.5' -l ligand.mol2 -s set_view.txt --axis_update --font Helvetica --fontsize 60
pHmap protein.pdb mutant.pdb -r '4 7 0.25' -l ligand.mol2 -s set_view.txt --digits 2
"
	printf 'Usage: %s [-r|--ph_range <arg>] [-l|--ligand <arg>] [-s|--set_view <arg>] [--level <arg>] [--rampcolors <arg>] [--(no-)surface_above] [--(no-)axis_update] [--digits <arg>] [--font <arg>] [--fontsize <arg>] [--weight <arg>] [--stretch <arg>] [--style <arg>] [--(no-)ramp] [--xalign <arg>] [--yalign <arg>] [--size <arg>] [--background <arg>] [-h|--help] [-v|--version] [-I|--include <arg>] [--] <pdb-1> [<pdb-2>] ... [<pdb-n>] ...\n' "$0"
	printf '\t%s\n' "<pdb>: pdb files to process)"
	printf '\t%s\n' "-r, --ph_range: range of pH's in quotes!; 'start stop step' e.g. '5 7 0.5' (no default)"
	printf '\t%s\n' "-l, --ligand: input mol2 file (no default)"
	printf '\t%s\n' "-s, --set_view: imports view settings from file; input file must contain
		the PyMol output of the get_view command! (no default)"
	printf '\t%s\n' "--level: level of pos and neg charge representation
		 (default: '5')"
	printf '\t%s\n' "--rampcolors: colors for ramp; 3 colors comma seperated
		 (default: 'red, white, blue')"
	printf '\t%s\n' "--surface_above, --no-surface_above: surface_ramp_above_mode from PyMol
		 (on by default)"
	printf '\t%s\n' "--axis_update, --no-axis_update: updates only the pH numbers of the x-axis
		 (off by default)"
	printf '\t%s\n' "--digits: digits of pH values in axis; if pH values like 5.25 change to 2!
		 (default: '1')"
	printf '\t%s\n' "--font: font of the axis; type <convert -list font>
		to get a full list of fonts available
		 (default: 'Helvetica')"
	printf '\t%s\n' "--fontsize: font size (default: '40')"
	printf '\t%s\n' "--weight: font weight; type  <convert -list weight>
		 to get a list of available weight settings
		 (default: 'Normal')"
	printf '\t%s\n' "--stretch: font stretch; type  <convert -list stretch>
		 to get a list of available stretch settings
		 (default: 'Normal')"
	printf '\t%s\n' "--style: font style; type  <convert -list style>
		 to get a list of available style settings
		 (default: 'Normal')"
	printf '\t%s\n' "--ramp, --no-ramp: enable/disable ramp
		 (on by default)"
	printf '\t%s\n' "--xalign: x-axis alignment of the pH value text; type  <convert -list gravity>
		 to get a list of available alignment settings
		 (default: 'Center')"
	printf '\t%s\n' "--yalign: y-axis alignment of the label text; type  <convert -list gravity>
		 to get a list of available alignment settings
		 (default: 'Center')"
	printf '\t%s\n' "--size: individual picture size: default means 500x500 pixel (quadratic; 300 dpi)
		 (default: '500')"
	printf '\t%s\n' "--background: background color: None, colors e.g. white, black (no default)"
	printf '\t%s\n' "-h, --help: Prints help"
	printf '\t%s\n' "-v, --version: Prints version"
	printf '\t%s' "-I, --include: Directory for temporary folder (default array elements:"
	printf " '%s'" '/tmp'
	printf ')\n'
}


parse_commandline()
{
	_positionals_count=0
	while test $# -gt 0
	do
		_key="$1"
		if test "$_key" = '--'
		then
			shift
			test $# -gt 0 || break
			_positionals+=("$@")
			_positionals_count=$((_positionals_count + $#))
			shift $(($# - 1))
			_last_positional="$1"
			break
		fi
		case "$_key" in
			-r|--ph_range)
				test $# -lt 2 && die "Missing value for the optional argument '$_key'." 1
				_arg_ph_range="$2"
				shift
				;;
			--ph_range=*)
				_arg_ph_range="${_key##--ph_range=}"
				;;
			-r*)
				_arg_ph_range="${_key##-r}"
				;;
			-l|--ligand)
				test $# -lt 2 && die "Missing value for the optional argument '$_key'." 1
				_arg_ligand="$2"
				shift
				;;
			--ligand=*)
				_arg_ligand="${_key##--ligand=}"
				;;
			-l*)
				_arg_ligand="${_key##-l}"
				;;
			-s|--set_view)
				test $# -lt 2 && die "Missing value for the optional argument '$_key'." 1
				_arg_set_view="$2"
				shift
				;;
			--set_view=*)
				_arg_set_view="${_key##--set_view=}"
				;;
			-s*)
				_arg_set_view="${_key##-s}"
				;;
			--level)
				test $# -lt 2 && die "Missing value for the optional argument '$_key'." 1
				_arg_level="$2"
				shift
				;;
			--level=*)
				_arg_level="${_key##--level=}"
				;;
			--rampcolors)
				test $# -lt 2 && die "Missing value for the optional argument '$_key'." 1
				_arg_rampcolors="$2"
				shift
				;;
			--rampcolors=*)
				_arg_rampcolors="${_key##--rampcolors=}"
				;;
			--no-surface_above|--surface_above)
				_arg_surface_above="on"
				test "${1:0:5}" = "--no-" && _arg_surface_above="off"
				;;
			--no-axis_update|--axis_update)
				_arg_axis_update="on"
				test "${1:0:5}" = "--no-" && _arg_axis_update="off"
				;;
			--digits)
				test $# -lt 2 && die "Missing value for the optional argument '$_key'." 1
				_arg_digits="$2"
				shift
				;;
			--digits=*)
				_arg_digits="${_key##--digits=}"
				;;
			--font)
				test $# -lt 2 && die "Missing value for the optional argument '$_key'." 1
				_arg_font="$2"
				shift
				;;
			--font=*)
				_arg_font="${_key##--font=}"
				;;
			--fontsize)
				test $# -lt 2 && die "Missing value for the optional argument '$_key'." 1
				_arg_fontsize="$2"
				shift
				;;
			--fontsize=*)
				_arg_fontsize="${_key##--fontsize=}"
				;;
			--weight)
				test $# -lt 2 && die "Missing value for the optional argument '$_key'." 1
				_arg_weight="$2"
				shift
				;;
			--weight=*)
				_arg_weight="${_key##--weight=}"
				;;
			--stretch)
				test $# -lt 2 && die "Missing value for the optional argument '$_key'." 1
				_arg_stretch="$2"
				shift
				;;
			--stretch=*)
				_arg_stretch="${_key##--stretch=}"
				;;
			--style)
				test $# -lt 2 && die "Missing value for the optional argument '$_key'." 1
				_arg_style="$2"
				shift
				;;
			--style=*)
				_arg_style="${_key##--style=}"
				;;
			--no-ramp|--ramp)
				_arg_ramp="on"
				test "${1:0:5}" = "--no-" && _arg_ramp="off"
				;;
			--xalign)
				test $# -lt 2 && die "Missing value for the optional argument '$_key'." 1
				_arg_xalign="$2"
				shift
				;;
			--xalign=*)
				_arg_xalign="${_key##--xalign=}"
				;;
			--yalign)
				test $# -lt 2 && die "Missing value for the optional argument '$_key'." 1
				_arg_yalign="$2"
				shift
				;;
			--yalign=*)
				_arg_yalign="${_key##--yalign=}"
				;;
			--size)
				test $# -lt 2 && die "Missing value for the optional argument '$_key'." 1
				_arg_size="$2"
				shift
				;;
			--size=*)
				_arg_size="${_key##--size=}"
				;;
			--background)
				test $# -lt 2 && die "Missing value for the optional argument '$_key'." 1
				_arg_background="$2"
				shift
				;;
			--background=*)
				_arg_background="${_key##--background=}"
				;;
			-h|--help)
				print_help
				exit 0
				;;
			-h*)
				print_help
				exit 0
				;;
			-v|--version)
				echo $0 v2.0
				exit 0
				;;
			-v*)
				echo $0 v2.0
				exit 0
				;;
			-I|--include)
				test $# -lt 2 && die "Missing value for the optional argument '$_key'." 1
				_arg_include+=("$2")
				shift
				;;
			--include=*)
				_arg_include+=("${_key##--include=}")
				;;
			-I*)
				_arg_include+=("${_key##-I}")
				;;
			*)
				_last_positional="$1"
				_positionals+=("$_last_positional")
				_positionals_count=$((_positionals_count + 1))
				;;
		esac
		shift
	done
}


handle_passed_args_count()
{
	local _required_args_string="'pdb'"
	test "${_positionals_count}" -ge 1 || _PRINT_HELP=yes die "FATAL ERROR: Not enough positional arguments - we require at least 1 (namely: $_required_args_string), but got only ${_positionals_count}." 1
}


assign_positional_args()
{
	local _positional_name _shift_for=$1
	_positional_names="_arg_pdb "
	_our_args=$((${#_positionals[@]} - 1))
	for ((ii = 0; ii < _our_args; ii++))
	do
		_positional_names="$_positional_names _arg_pdb[$((ii + 1))]"
	done

	shift "$_shift_for"
	for _positional_name in ${_positional_names}
	do
		test $# -gt 0 || break
		eval "$_positional_name=\${1}" || die "Error during argument parsing, possibly an Argbash bug." 1
		shift
	done
}

parse_commandline "$@"
handle_passed_args_count
assign_positional_args 1 "${_positionals[@]}"

# OTHER STUFF GENERATED BY Argbash

### END OF CODE GENERATED BY Argbash (sortof) ### ])
# [ <-- needed because of Argbash

## Variables
SECONDS=0
TEMP="$_arg_include"
WPATH="$(pwd)"
export LC_NUMERIC="en_US.UTF-8"

### arguments var
#### ligandFlag
if [[ -n "$_arg_ligand" ]]; then
    ligandFlag=$(echo --ligand=$_arg_ligand)
fi

#### set_view
if [[ -z "$_arg_set_view" ]]; then
    view=" "
else
    view=$(cat $_arg_set_view)
fi
#### range
rangeMin=$(echo ${_arg_ph_range} | cut -d " " -f 1)
rangeMax=$(echo ${_arg_ph_range} | cut -d " " -f 2)
rangeInc=$(echo ${_arg_ph_range} | cut -d " " -f 3)
pHmin=$($LCNum printf "%.${_arg_digits}f" $rangeMin) # pH values
pHinc=$(printf "%.${_arg_digits}f" $rangeInc) # increment for range with digits to choose
pHmax=$(printf "%.${_arg_digits}f" $rangeMax) # pH values

for i in `seq $pHmin $pHinc $pHmax`; do
    pHrange=$(printf "%.${_arg_digits}f\n" $pHrange $i)
done >/dev/null 2>/dev/null
#### pymol settings
if [ $_arg_surface_above = "off" ]; then
    above_mode=" "
else
    above_mode="set surface_ramp_above_mode"
fi
#### convert settings
fontSize=46
offsetFactor=$(echo $fontSize/12.5 | bc -l)
axisPageSize=$(echo $_arg_fontsize*1.15 | bc -l) # axispagehighnes is 1.25 times higher then fontsize

picSizefactor=$(echo $axisPageSize/$fontSize)
rampWidthFactor=$(echo $_arg_size/500 | bc -l) # 500 is default --size flag!!!

picHigh=$(echo $axisPageSize*$rampWidthFactor | bc -l)
rampHigh=$(echo $fontSize*$rampWidthFactor | bc -l)
fontHigh=$(echo $axisPageSize*$rampWidthFactor | bc -l)

offset=$(echo $rampHigh/$offsetFactor | bc -l) #4.545454545 from fontsize 40 comes 50 for axisPageSize and 11 is needed as offset, therefore 50/11 as factor to center ramp.

backGround="$_arg_background" # background color
if [[ -z "$backGround" ]]; then
    backGroundTrans="off"
    backGround="None"
else
    backGroundTrans="on"
fi

## Functions
timeNeed () {
ELAPSED="$(($SECONDS / 3600))hrs $((($SECONDS / 60) % 60))min $(($SECONDS % 60))sec"
printf "|%-30s%30s|\n\n" "Program finished within:" "$ELAPSED"
}

check () {
#checks if pdb file is given
if [[ -z "$rangeMin" ]] && [[ -z "$rangeMax" ]] && [[ -z "$rangeInc" ]]; then
	printf "\n|%-60s|\n" "                   error in -r, --ph_range"
	printf "|%-60s|\n\n" "                     pHmap -h for help!"
else
    runScript
fi
}

picGen () {
for l in ${_arg_pdb[*]}; do
    printf "|%-30s%30s|\n" "Processing file:" "$l"
    label=$(echo $l | cut -d "." -f 1)
    for i in $pHrange; do
        printf "|%5s%-35s%20s|\n" "" "Running pdb2pqr @" "pH $i"
        pdb2pqr --with-ph=$i --ph-calc-method=propka --drop-water --apbs-input --ff=parse $ligandFlag $l $label-$i-p2p.pqr > $label-p2p-stout.log 2> $label-p2p-sterr.log
        sleep 1s
        printf "|%5s%-35s%20s|\n" "" "Running apbs @" "pH $i"
        apbs --output-file=$label-$i-apbs.log $label-$i-p2p.in > $label-apbs-stout.log 2> $label-apbs-sterr.log
        sleep 1s

        printf "
load $label-$i-p2p.pqr.dx
load $label-$i-p2p.pqr
as surface
show sticks, hetatm
ramp_new ramp, $label-$i-p2p.pqr, [-$_arg_level, 0, $_arg_level], [$_arg_rampcolors]
set surface_color, ramp
$above_mode
disable ramp
$view
center
zoom
set opaque_background, $backGroundTrans
bg_color $backGround
png $label-$i-pic.png, width=$_arg_size, height=$_arg_size, dpi=300
hide everything
enable ramp
png rawRamp.png, width=$_arg_size, height=$_arg_size, dpi=300"> rendering.pml

        printf "|%5s%-35s%20s|\n" "" "Rendering figure with PyMol @" "pH $i"
        pymol -cq rendering.pml > $label-pymol-stout.log 2> $label-pymol-sterr.log
    done
    list=$(ls -tr $WPATH/$label-*-pic.png)
    convert +append $list $label-pH_profile_pic.png
done
}

numGen () {
for i in $pHrange; do
    convert -size ${_arg_size}x$picHigh -gravity $_arg_xalign -background  $backGround -weight $_arg_weight -stretch $_arg_stretch -style $_arg_style -pointsize $_arg_fontsize -family $_arg_font label:$i $WPATH/$i-number.png
done
}

labelGen () {
for i in ${_arg_pdb[*]}; do
    label=$(echo $i | cut -d "." -f 1)
    convert -size ${_arg_size}x${_arg_size} -gravity $_arg_yalign -background $backGround -weight $_arg_weight -stretch $_arg_stretch -style $_arg_style -pointsize $_arg_fontsize -family $_arg_font label:$label $WPATH/$label-label.png
done
}

emptyGen () {
    convert -size ${_arg_size}x$picHigh xc:None empty.png
}
rampGen () {
    convert rawRamp.png -gravity South -crop ${_arg_size}x${rampHigh}+0+$offset -gravity Center -resize ${_arg_size}x$rampHigh -background $backGround -compose Copy -extent ${_arg_size}x$rampHigh .rampInter.png
    convert .rampInter.png -gravity Center -resize ${_arg_size}x$fontHigh -background None -compose Copy -extent ${_arg_size}x$fontHigh ramp.png
    }

picCombine () {
printf "\n|%-60s|\n" "Generating final figure and cleaning up"
#xaxis
list=$(ls -tr $WPATH/*-number.png)
convert +append $list xaxis_number.png
#yaxis
list=$(ls -tr $WPATH/*-label.png)
if [ $_arg_ramp = "on" ]; then
    convert -append $list ramp.png yaxis_label.png

else
    convert -append $list empty.png yaxis_label.png
fi
#pic and xaxis
list=$(ls -tr *-pH_profile_pic.png)
convert -append $list xaxis_number.png pH_profile.png
#pic, xaxis and yaxis
convert +append yaxis_label.png pH_profile.png pH_profile+label.png
}

cleanUp () {
#cleans up the directory
mkdir p2pFiles >/dev/null 2>/dev/null
mkdir logFiles >/dev/null 2>/dev/null
mkdir pngFiles >/dev/null 2>/dev/null

mv *.log logFiles >/dev/null 2>/dev/null
mv *p2p* p2pFiles >/dev/null 2>/dev/null
mv *-pic.png pngFiles >/dev/null 2>/dev/null
mv *-number.png pngFiles >/dev/null 2>/dev/null
mv *-label.png pngFiles >/dev/null 2>/dev/null
rm io.mc >/dev/null 2>/dev/null
}

## SCRIPT
runScript () {
date=$(date)
printf "\n|%-30s%30s|\n\n" "pHmap started @" "$date"


if [ $_arg_axis_update = "on" ]; then
    # only run convert
    WPATH=$(echo $WPATH/pngFiles)
    rm $WPATH/*-number.png >/dev/null 2>/dev/null
    rm $WPATH/*-label.png >/dev/null 2>/dev/null
    numGen
    labelGen
    emptyGen
    rampGen
    picCombine
else
    picGen
    numGen
    labelGen
    emptyGen
    rampGen
    picCombine
fi
cleanUp
timeNeed
}
check
# ] <-- needed because of Argbash
